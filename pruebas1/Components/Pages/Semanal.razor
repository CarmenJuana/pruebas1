@page "/semanal"
@using System
@using System.Collections.Generic
@using System.Globalization
@inject IJSRuntime JSRuntime


<div class="agenda-container">

    <header class="agenda-header">
        <button class="btn" @onclick="PrevWeek">
            <span class="arrow">&#9664;</span> Semana anterior
        </button>

        <h1>Semana @WeekNumber - @MonthName</h1>

        <button class="btn primary" @onclick="NextWeek">
            Semana siguiente <span class="arrow">&#9654;</span>
        </button>
    </header>

    <div class="days-grid weekly">
        @foreach (var day in Days.Where(d => d.Date.DayOfWeek != DayOfWeek.Sunday))
        {
            <div class="day-card">
                <div class="day-header">
                    <span class="day-name">@day.Date.ToString("dddd", new CultureInfo("es-ES"))</span>
                    <span class="day-date">@day.Date.ToString("dd")</span>
                </div>

                <div class="blocks-list">
                    @foreach (var block in day.Blocks)
                    {
                        <div class="list-item" style="background-color:@block.Color">
                            <div class="list-title" @onclick="() => ToggleBlock(block)">
                                @block.Title
                                <span style="float:right">@((block.IsExpanded ? "▼" : "►"))</span>
                            </div>

                            @if (block.IsExpanded)
                            {
                                <ul class="subtasks">
                                    @foreach (var task in block.SubTasks)
                                    {
                                        <li class="task-item">
                                            @if (task is BaseTask bt)
                                            {
                                                @if (block.Title != "Órdenes de Trabajo")
                                                {
                                                    <input type="checkbox" @bind="bt.IsCompleted" />
                                                    <span class="task-name" @onclick="() => OpenTaskModal(bt, false)">
                                                        @bt.Name
                                                    </span>
                                                    <button class="edit-btn" title="Editar" @onclick="() => OpenTaskModal(bt, true)">✏️</button>
                                                    <button class="delete-btn" title="Eliminar" @onclick="() => DeleteTask(bt)">🗑️</button>
                                                }
                                                else
                                                {
                                                    <!-- Órdenes de Trabajo: solo mostrar nombre, nada más -->
                                                    <span>@bt.Name</span>
                                                }
                                            }
                                            else if (task is SelfAssessment sa)
                                            {
                                                <input type="checkbox" @bind="sa.IsCompleted" />
                                                <span class="task-name" @onclick="() => OpenTaskModal(sa, false)">
                                                    @sa.ActivityName
                                                </span>
                                            }

                                        </li>
                                    }
                                </ul>
                            }
                        </div>
                    }
                </div>
            </div>
        }
    </div>
</div>

@if (IsModalOpen && SelectedTaskObject != null)
{
    <div class="modal-backdrop" @onclick="CloseTaskModal"></div>

    <div class="modal-content">
        <div class="modal-header">
            <h2>@GetModalTitle()</h2>
            <button class="close-btn" @onclick="CloseTaskModal">&times;</button>
        </div>

        <div class="modal-body">
            @if (SelectedTaskObject is BaseTask bt)
            {
                <div class="form-group">
                    <label>Actividad:</label>
                    <input type="text" @bind="bt.Name" disabled="@(!IsEditMode)" />
                </div>
                <div class="form-group">
                    <label>Descripción:</label>
                    <textarea @bind="bt.Description" disabled="@(!IsEditMode)"></textarea>
                </div>
                <div class="form-group">
                    <label>Prioridad:</label>
                    <select @bind="bt.Priority" disabled="@(!IsEditMode)">
                        <option value="Alta">🔴 Alta</option>
                        <option value="Media">🟡 Media</option>
                        <option value="Baja">🟢 Baja</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>Recurrencia:</label>
                    <select @bind="bt.Recurrence" disabled="@(!IsEditMode)">
                        <option value="No repetir">No repetir</option>
                        <option value="Diario">Diario</option>
                        <option value="Semanal">Semanal</option>
                        <option value="Quincenal">Quincenal</option>
                        <option value="Mensual">Mensual</option>
                        <option value="Anual">Anual</option>
                    </select>
                </div>
                <div class="form-group inline">
                    <label>Fecha inicio</label>
                    <input type="date" @bind="bt.StartDate" disabled="@(!IsEditMode)" />
                </div>
                <div class="form-group inline">
                    <label>Fecha fin</label>
                    <input type="date" @bind="bt.DueDate" disabled="@(!IsEditMode)" />
                </div>
            }
            else if (SelectedTaskObject is SelfAssessment sa)
            {
                <div class="form-group">
                    <label>Actividad:</label>
                    <p class="read-only-field">@sa.ActivityName</p>
                </div>
            }
        </div>

        <div class="modal-footer">
            @if (IsEditMode)
            {


                <button class="action-btn save" @onclick="SaveTask">💾 Guardar</button>

                <button class="action-btn cancel" @onclick="CancelEdit">❌ Cancelar</button>
            }
            else
            {
                <button class="action-btn save" @onclick="() => IsModalOpen = false">✔️ Cerrar</button>
            }
        </div>
    </div>
}

@code {
    enum BlockType { AdminTask, WorkOrder, GeneralTask, SelfAssessment }

    class BaseTask
    {
        public Guid Id { get; set; } = Guid.NewGuid();
        public BlockType Type { get; set; }
        public string Name { get; set; }
        public string Description { get; set; }
        public string Priority { get; set; } = "Media";
        public string Recurrence { get; set; } = "No repetir";
        public bool IsCompleted { get; set; } = false;
        public DateTime StartDate { get; set; } = DateTime.Today;
        public DateTime DueDate { get; set; } = DateTime.Today;
        public List<object> SubTasks { get; set; } = new();
        public Block ParentBlock { get; set; }
    }
    async Task ShowAlert(string message)
    {
        await JSRuntime.InvokeVoidAsync("alert", message);
    }

    void ToggleBlock(Block block)
    {
        block.IsExpanded = !block.IsExpanded;
    }


    class AdminTask : BaseTask { }
    class GeneralTask : BaseTask { }
    class WorkOrder : BaseTask { }

    class SelfAssessment
    {
        public Guid Id { get; set; } = Guid.NewGuid();
        public string ActivityName { get; set; }
        public bool IsCompleted { get; set; } = false;
        public Block ParentBlock { get; set; }
    }

    class Block
    {
        public string Title { get; set; }
        public List<object> SubTasks { get; set; } = new();
        public string Color { get; set; }
        public bool IsExpanded { get; set; } = false;
    }

    class DayColumn
    {
        public DateTime Date { get; set; }
        public List<Block> Blocks { get; set; } = new();
    }

    List<DayColumn> Days = new();
    DateTime CurrentDate = DateTime.Today;
    object SelectedTaskObject { get; set; }
    bool IsModalOpen { get; set; } = false;
    bool IsEditMode { get; set; } = false;

    int WeekNumber => CultureInfo.CurrentCulture.Calendar.GetWeekOfYear(CurrentDate, CalendarWeekRule.FirstFourDayWeek, DayOfWeek.Monday);
    string MonthName => CultureInfo.GetCultureInfo("es-ES").DateTimeFormat.GetMonthName(CurrentDate.Month);

    protected override void OnInitialized() => BuildWeek();

    void BuildWeek()
    {
        Days.Clear();
        var diff = (7 + (CurrentDate.DayOfWeek - DayOfWeek.Monday)) % 7;
        var monday = CurrentDate.AddDays(-1 * diff).Date;

        for (int i = 0; i < 7; i++)
            Days.Add(CreateDay(monday.AddDays(i)));
    }

    DayColumn CreateDay(DateTime date)
    {
        var day = new DayColumn { Date = date };
        if (date.DayOfWeek == DayOfWeek.Sunday) return day;

        // Tareas Administrativas
        var adminBlock = new Block { Title = "Tareas Administrativas", Color = "#FFD1DC" };
        var t1 = new AdminTask { Name = "Área de TI limpia", Description = "Me aseguré de que el área y la estación de insumos de TI esté limpia, ordenada y funcional", ParentBlock = adminBlock, Type = BlockType.AdminTask };
        t1.SubTasks.Add(new BaseTask { Name = "Subtarea 1" });
        t1.SubTasks.Add(new BaseTask { Name = "Subtarea 2" });
        var t2 = new AdminTask { Name = "Control de suscripciones", Description = "Di seguimiento en tiempo y forma al control de suscripciones de las que es responsable TI.", ParentBlock = adminBlock, Type = BlockType.AdminTask };
        var t3 = new AdminTask { Name = "Recepción de facturas", Description = "Di seguimiento a la recepción de facturas de acuerdo con las solicitudes de pago y las entregue a Administración.", ParentBlock = adminBlock, Type = BlockType.AdminTask };
        adminBlock.SubTasks.Add(t1); adminBlock.SubTasks.Add(t2); adminBlock.SubTasks.Add(t3);
        day.Blocks.Add(adminBlock);

        // Tareas Operativas
        var opBlock = new Block { Title = "Tareas Operativas", Color = "#B5EAD7" };
        var o1 = new GeneralTask { Name = "Entregar reporte semanal", Description = "Revisar bien los reportes de la semana", ParentBlock = opBlock, Type = BlockType.GeneralTask };
        var o2 = new GeneralTask { Name = "Reunión equipo", Description = "Llevar el control de las reuniones hechas", ParentBlock = opBlock, Type = BlockType.GeneralTask };
        var o3 = new GeneralTask { Name = "Entrega reporte semanal", Description = "Revisar que los reportes de mis compañeros los suban", ParentBlock = opBlock, Type = BlockType.GeneralTask };
        opBlock.SubTasks.Add(o1); opBlock.SubTasks.Add(o2); opBlock.SubTasks.Add(o3);
        day.Blocks.Add(opBlock);

        // Órdenes de Trabajo
        var woBlock = new Block { Title = "Órdenes de Trabajo", Color = "#FFDAC1" };
        woBlock.SubTasks.Add(new WorkOrder { Name = "ORD-13683" });
        woBlock.SubTasks.Add(new WorkOrder { Name = "ORD-13503" });
        woBlock.SubTasks.Add(new WorkOrder { Name = "ORD-13296" });
        day.Blocks.Add(woBlock);

        // Autoevaluación
        var autoBlock = new Block { Title = "Autoevaluación", Color = "#E2F0CB" };
        autoBlock.SubTasks.Add(new SelfAssessment { ActivityName = "Me aseguré de que el área y la estación de insumos de TI esté limpia, ordenada y funcional.", ParentBlock = autoBlock });
        autoBlock.SubTasks.Add(new SelfAssessment { ActivityName = "Validé que los vales de papelería relacionados con los insumos de TI se encuentren llenados correctamente; realicé el escaneo de los mismos y entregué a servicios de oficina.", ParentBlock = autoBlock });
        autoBlock.SubTasks.Add(new SelfAssessment { ActivityName = "Confirmé con el personal de TI, al menos 2 veces al día, las actividades programadas de acuerdo con su programa de trabajo.", ParentBlock = autoBlock });
        day.Blocks.Add(autoBlock);

        return day;
    }

    string GetModalTitle()
    {
        if (SelectedTaskObject is BaseTask bt)
            return bt.Type switch
            {
                BlockType.AdminTask => "Tarea Administrativa",
                BlockType.GeneralTask => "Tarea Operativa",
                _ => "Detalles de la tarea"
            };
        else if (SelectedTaskObject is SelfAssessment)
            return "Registro de Autoevaluación";
        return "Detalles";
    }

    void OpenTaskModal(object task, bool editMode)
    {
        SelectedTaskObject = task;
        IsModalOpen = true;
        IsEditMode = editMode;
    }

    void CloseTaskModal()
    {
        SelectedTaskObject = null;
        IsModalOpen = false;
        IsEditMode = false;
    }

    void SaveTask()
    {
        IsEditMode = false;
    }

    void CancelEdit()
    {
        IsEditMode = false;
    }

    void DeleteTask(BaseTask bt)
    {
        if (bt.Type == BlockType.AdminTask || bt.Type == BlockType.GeneralTask)
        {
            if (!JSRuntime.InvokeAsync<bool>("confirm", $"¿Estás seguro de eliminar la tarea '{bt.Name}'?").Result)
                return;
        }
        bt.ParentBlock?.SubTasks.Remove(bt);
    }

    void PrevWeek() { CurrentDate = CurrentDate.AddDays(-7); BuildWeek(); }
    void NextWeek() { CurrentDate = CurrentDate.AddDays(7); BuildWeek(); }
}

<style>
    / /* Contenedor principal */
    .agenda-container {
        font-family: Inter, sans-serif;
        background: #fff;
        padding: 20px;
        border-radius: 12px;
        width: 100vw;
        height: 100vh; /* Ocupa toda la pantalla */
        display: flex;
        flex-direction: column;
        box-sizing: border-box;
        overflow: hidden; /* Evita espacios extra */
    }

    /* Header */
    .agenda-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 12px;
    }

        .agenda-header h1 {
            margin: 0;
            flex-grow: 1;
            text-align: center;
        }

    /* Botones */
    .btn {
        background: #0B3C4A;
        color: white;
        border: none;
        padding: 6px 12px;
        border-radius: 6px;
        cursor: pointer;
        display: flex;
        align-items: center;
        gap: 5px;
    }

        .btn:hover {
            background: #09333e;
        }

    /* Grid de días */
    .days-grid.weekly {
        display: grid;
        grid-template-columns: repeat(6, 1fr);
        gap: 12px;
        flex-grow: 1;
        overflow-y: auto; /* Scroll si se excede altura */
    }

    /* Tarjetas de día */
    .day-card {
        background: #f9fafb;
        border-radius: 10px;
        padding: 12px;
        display: flex;
        flex-direction: column;
        gap: 8px;
        max-height: 100%;
        overflow-y: auto;
    }

    /* Header del día */
    .day-header {
        display: flex;
        justify-content: space-between;
        font-weight: 600;
        text-transform: capitalize;
    }

    /* Lista de bloques */
    .blocks-list {
        display: flex;
        flex-direction: column;
        gap: 6px;
    }

    /* Bloques individuales */
    .list-item {
        border-radius: 8px;
        padding: 8px 10px;
        box-shadow: 0 2px 5px rgba(0,0,0,0.05);
        cursor: pointer;
        transition: all 0.2s ease;
    }

    /* Título del bloque */
    .list-title {
        font-weight: 600;
        margin-bottom: 4px;
        user-select: none;
    }

    /* Subtareas */
    .subtasks {
        list-style: none;
        padding-left: 0;
        margin: 0;
        display: flex;
        flex-direction: column;
        gap: 4px;
        max-height: 300px;
        overflow-y: auto; /* Scroll interno si muchas subtareas */
    }

    /* Ítems de tarea */
    .task-item {
        display: flex;
        align-items: center;
        justify-content: space-between;
        padding: 6px 0;
        border-bottom: 1px solid #ddd;
    }

    /* Nombre de la tarea */
    .task-name {
        flex-grow: 1;
        cursor: pointer;
    }

    /* Botones de editar y eliminar */
    .edit-btn, .delete-btn {
        font-size: 14px;
        background: none;
        border: none;
        cursor: pointer;
        margin-left: 4px;
    }

    /* Modal */
    .modal-backdrop {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(11,60,74,0.7);
        z-index: 1000;
    }

    .modal-content {
        position: fixed;
        top: 50%;
        left: 50%;
        transform: translate(-50%,-50%);
        background: #FEFEFE;
        padding: 20px;
        border-radius: 12px;
        z-index: 1001;
        width: 90%;
        max-width: 600px;
        max-height: 80vh;
        overflow-y: auto;
        box-shadow: 0 8px 25px rgba(0,0,0,0.25);
    }

    /* Header del modal */
    .modal-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 12px;
        border-bottom: 2px solid #FFDAC1;
        padding-bottom: 5px;
    }

    .close-btn {
        font-size: 24px;
        background: none;
        border: none;
        cursor: pointer;
        color: #0B3C4A;
    }

    /* Formulario dentro del modal */
    .form-group {
        margin-bottom: 10px;
    }

        .form-group label {
            display: block;
            font-weight: 600;
            margin-bottom: 2px;
        }

        .form-group input,
        .form-group select,
        .form-group textarea {
            width: 100%;
            padding: 6px 8px;
            border-radius: 6px;
            border: 1px solid #FFDAC1;
            box-sizing: border-box;
        }

    textarea {
        min-height: 50px;
        resize: vertical;
    }

        input:disabled, textarea:disabled, select:disabled {
            background: #f7f7f7;
            color: #555;
        }

    /* Tabla de sub-tareas */
    .subtask-table {
        width: 100%;
        border-collapse: collapse;
        margin-top: 6px;
    }

        .subtask-table th, .subtask-table td {
            border: 1px solid #ddd;
            padding: 4px;
            text-align: left;
        }

    /* Footer modal */
    .modal-footer {
        display: flex;
        justify-content: flex-end;
        gap: 6px;
        padding-top: 8px;
        border-top: 1px solid #eee;
    }

    /* Botones de acción */
    .action-btn {
        padding: 6px 12px;
        font-weight: 700;
        color: white;
        border: none;
        border-radius: 50px;
        cursor: pointer;
        font-size: 14px;
    }

        .action-btn.save {
            background: #0B3C4A;
        }

        .action-btn.cancel {
            background: #ef4444;
        }

</style>
